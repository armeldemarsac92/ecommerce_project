default:
  image: docker:24.0.5

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_DRIVER: overlay2
  GIT_DEPTH: 0
  ECR_REPO: "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/t-dev-702/prod"

stages:
  - test
  - build
  - terraform:validate
  - terraform:plan
  - terraform:apply



frontend-test:
  stage: test
  image: cypress/browsers:22.12.0
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - web/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - web/**/*
  cache:
    key: ${CI_COMMIT_REF_SLUG}-frontend
    paths:
      - web/node_modules/
  before_script:
    - cd $CI_PROJECT_DIR/web
    - yarn install
  script:
    - yarn run lint || true
    - yarn test || true
    - yarn run test:coverage || true
    - yarn dev &
    - sleep 30
    - yarn cypress run --headless
  artifacts:
    when: always
    paths:
      - web/cypress/screenshots/**/*
  allow_failure: true

api-test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - api/Tdev702.Api/**/*
        - api/Tdev702.Contracts/**/*
        - api/Tdev702.Repository/**/*
        - api/Tdev702.AWS.SDK/**/*
        - api/Tdev702.Stripe.SDK/**/*
        - api/Tdev702.OpenFoodFact.SDK/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - api/Tdev702.Api/**/*
        - api/Tdev702.Contracts/**/*
        - api/Tdev702.Repository/**/*
        - api/Tdev702.AWS.SDK/**/*
        - api/Tdev702.Stripe.SDK/**/*
        - api/Tdev702.OpenFoodFact.SDK/**/*
  cache:
    key: ${CI_COMMIT_REF_SLUG}-api
    paths:
      - api/*/obj/
      - api/*/bin/
  before_script:
    - cd $CI_PROJECT_DIR/api
    - dotnet restore
  script:
    - dotnet test ./Tdev702.Api.Tests.Unit/Tdev702.Api.Tests.Unit.csproj
  allow_failure: true

.ecr_login: &ecr_login
  before_script:
    - apk add --no-cache git aws-cli
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set default.region $AWS_REGION
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO

.terraform_setup: &terraform_setup
  before_script:
    # Install required tools
    - apk add --no-cache git aws-cli curl unzip
    
    # Configure AWS
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set default.region $AWS_REGION
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO
    
    # Install Terraform
    - curl -LO https://releases.hashicorp.com/terraform/1.7.4/terraform_1.7.4_linux_amd64.zip
    - unzip terraform_1.7.4_linux_amd64.zip
    - mv terraform /usr/local/bin/


build-frontend:
  stage: build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - web/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - web/**/*
  needs:
    - job: frontend-test
      optional: true
  <<: *ecr_login
  script:
    - cd $CI_PROJECT_DIR/web
    - docker build --load -t t-dev-702-web:latest -f ./Dockerfile .
    - docker tag t-dev-702-web:latest $ECR_REPO/frontend:latest
    - docker push $ECR_REPO/frontend:latest

build-api:
  stage: build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - api/Tdev702.Api/**/*
        - api/Tdev702.Contracts/**/*
        - api/Tdev702.Repository/**/*
        - api/Tdev702.AWS.SDK/**/*
        - api/Tdev702.Stripe.SDK/**/*
        - api/Tdev702.OpenFoodFact.SDK/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - api/Tdev702.Api/**/*
        - api/Tdev702.Contracts/**/*
        - api/Tdev702.Repository/**/*
        - api/Tdev702.AWS.SDK/**/*
        - api/Tdev702.Stripe.SDK/**/*
        - api/Tdev702.OpenFoodFact.SDK/**/*
  needs:
    - job: api-test
      optional: true
  <<: *ecr_login
  script:
    - cd $CI_PROJECT_DIR/api
    - docker build --load -t t-dev-702-api:latest -f ./Tdev702.Api/Dockerfile .
    - docker tag t-dev-702-api:latest $ECR_REPO/api:latest
    - docker push $ECR_REPO/api:latest

build-auth:
  stage: build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - api/Tdev702.Auth/**/*
        - api/Tdev702.Contracts/**/*
        - api/Tdev702.Repository/**/*
        - api/Tdev702.Stripe.SDK/**/*
        - api/Tdev702.AWS.SDK/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - api/Tdev702.Auth/**/*
        - api/Tdev702.Contracts/**/*
        - api/Tdev702.Repository/**/*
        - api/Tdev702.Stripe.SDK/**/*
        - api/Tdev702.AWS.SDK/**/*
  <<: *ecr_login
  script:
    - cd $CI_PROJECT_DIR/api
    - docker build --load -t t-dev-702-auth:latest -f ./Tdev702.Auth/Dockerfile .
    - docker tag t-dev-702-auth:latest $ECR_REPO/auth:latest
    - docker push $ECR_REPO/auth:latest
      
terraform:validate:
  stage: terraform:validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - api/terraform/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - api/terraform/**/*
  <<: *terraform_setup
  script:
    - cd $CI_PROJECT_DIR/api/terraform
    - terraform init
    - terraform validate
    - terraform fmt || true

terraform:plan:
  stage: terraform:plan
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - api/terraform/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - api/terraform/**/*
  <<: *terraform_setup
  script:
    - cd $CI_PROJECT_DIR/api/terraform
    - terraform init
    - terraform plan -out=tfplan | tee terraform_plan_output.txt
    - terraform show -no-color tfplan > tfplan.txt
    - |
      if [ "$CI_PIPELINE_SOURCE" == "merge_request_event" ]; then
        # Format the comment with markdown
        echo "## Terraform Plan Results" > comment.txt
        echo "" >> comment.txt
        echo "\`\`\`terraform" >> comment.txt
        cat tfplan.txt >> comment.txt
        echo "\`\`\`" >> comment.txt
      
        # Post the comment to the MR
        apk add --no-cache curl jq
        COMMENT=$(jq -Rs '{"body": .}' comment.txt)
        curl --request POST \
          --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
          --header "Content-Type: application/json" \
          --data "$COMMENT" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"
      fi
  artifacts:
    paths:
      - api/terraform/tfplan
      - api/terraform/tfplan.txt
      - api/terraform/terraform_plan_output.txt
    expire_in: 1 week

terraform:apply:
  stage: terraform:apply
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - api/terraform/**/*
      when: manual
  <<: *terraform_setup
  script:
    - cd $CI_PROJECT_DIR/api/terraform
    - terraform init
    - terraform apply -auto-approve
  environment:
    name: production
    on_stop: terraform:destroy

terraform:destroy:
  stage: terraform:apply
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - api/terraform/**/*
      when: manual
  <<: *terraform_setup
  script:
    - cd $CI_PROJECT_DIR/api/terraform
    - terraform init
    - terraform destroy -auto-approve
  environment:
    name: production
    action: stop