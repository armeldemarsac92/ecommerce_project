stages:
  - test
  - build
  - deploy-infra
  - wait-for-infra
  - integration-test
  - promote

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_DRIVER: overlay2
  GIT_DEPTH: 0
  # Infrastructure repository variables
  INFRA_PROJECT_ID: "67593851" # Replace with your infrastructure repository project ID
  INFRA_TRIGGER_TOKEN: ${TRIGGER_TOKEN} # Set this in GitLab CI/CD variables

# Your existing ECR login anchor
.ecr_login: &ecr_login
  before_script:
    - apk add --no-cache git aws-cli
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set default.region $AWS_REGION
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO

# Test jobs
frontend-test:
  stage: test
  script:
    - echo "Running frontend tests..."
    # Add your actual test commands here

api-test:
  stage: test
  script:
    - echo "Running API tests..."
    # Add your actual test commands here

# Staging build jobs - direct build to staging paths
build-frontend-staging:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
#      changes:
#        - web/**/*
  needs:
    - job: frontend-test
      optional: true
  <<: *ecr_login
  script:
    - cd $CI_PROJECT_DIR/web
    - docker build --load -t t-dev-702-web-staging:$CI_COMMIT_SHA -f ./Dockerfile .
    - docker tag t-dev-702-web-staging:$CI_COMMIT_SHA $ECR_REPO/staging/frontend:$CI_COMMIT_SHA
    - docker tag t-dev-702-web-staging:$CI_COMMIT_SHA $ECR_REPO/staging/frontend:latest
    - docker push $ECR_REPO/staging/frontend:$CI_COMMIT_SHA
    - docker push $ECR_REPO/staging/frontend:latest

build-api-staging:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
#      changes:
#        - api/Tdev702.Api/**/*
#        - api/Tdev702.Contracts/**/*
#        - api/Tdev702.Repository/**/*
#        - api/Tdev702.AWS.SDK/**/*
#        - api/Tdev702.Stripe.SDK/**/*
#        - api/Tdev702.OpenFoodFact.SDK/**/*
  needs:
    - job: api-test
      optional: true
  <<: *ecr_login
  script:
    - cd $CI_PROJECT_DIR/api
    - docker build --load -t t-dev-702-api-staging:$CI_COMMIT_SHA -f ./Tdev702.Api/Dockerfile .
    - docker tag t-dev-702-api-staging:$CI_COMMIT_SHA $ECR_REPO/staging/api:$CI_COMMIT_SHA
    - docker tag t-dev-702-api-staging:$CI_COMMIT_SHA $ECR_REPO/staging/api:latest
    - docker push $ECR_REPO/staging/api:$CI_COMMIT_SHA
    - docker push $ECR_REPO/staging/api:latest

build-auth-staging:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
#      changes:
#        - api/Tdev702.Auth/**/*
#        - api/Tdev702.Contracts/**/*
#        - api/Tdev702.Repository/**/*
#        - api/Tdev702.Stripe.SDK/**/*
#        - api/Tdev702.AWS.SDK/**/*
  <<: *ecr_login
  script:
    - cd $CI_PROJECT_DIR/api
    - docker build --load -t t-dev-702-auth-staging:$CI_COMMIT_SHA -f ./Tdev702.Auth/Dockerfile .
    - docker tag t-dev-702-auth-staging:$CI_COMMIT_SHA $ECR_REPO/staging/auth:$CI_COMMIT_SHA
    - docker tag t-dev-702-auth-staging:$CI_COMMIT_SHA $ECR_REPO/staging/auth:latest
    - docker push $ECR_REPO/staging/auth:$CI_COMMIT_SHA
    - docker push $ECR_REPO/staging/auth:latest

# Trigger infrastructure update for staging
trigger-infra-staging:
  stage: deploy-infra
  needs:
    - job: build-frontend-staging
      optional: true
    - job: build-api-staging
      optional: true
    - job: build-auth-staging
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
  script:
    - echo "Triggering infrastructure pipeline for staging environment"
    - |
      PIPELINE_RESPONSE=$(curl --request POST \
        --form "token=$INFRA_TRIGGER_TOKEN" \
        --form "ref=main" \
        --form "variables[ENVIRONMENT]=staging" \
        --form "variables[API_IMAGE_TAG]=$CI_COMMIT_SHA" \
        --form "variables[AUTH_IMAGE_TAG]=$CI_COMMIT_SHA" \
        --form "variables[FRONTEND_IMAGE_TAG]=$CI_COMMIT_SHA" \
        "https://gitlab.com/api/v4/projects/$INFRA_PROJECT_ID/trigger/pipeline")
    - echo "Pipeline response: $PIPELINE_RESPONSE"
    - INFRA_PIPELINE_ID=$(echo $PIPELINE_RESPONSE | jq -r '.id')
    - if [ "$INFRA_PIPELINE_ID" == "null" ]; then echo "Failed to trigger infrastructure pipeline"; exit 1; fi
    - echo "INFRA_PIPELINE_ID=$INFRA_PIPELINE_ID" >> variables.env
  artifacts:
    reports:
      dotenv: variables.env

# Wait for infrastructure to be ready
wait-for-infra-staging:
  stage: wait-for-infra
  needs:
    - trigger-infra-staging
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
  script:
    - echo "Waiting for infrastructure pipeline $INFRA_PIPELINE_ID to complete..."
    - |
      status="pending"
      max_retries=30
      retries=0
      
      while [ "$status" != "success" ] && [ "$status" != "failed" ] && [ "$status" != "canceled" ]; do
        sleep 30
        retries=$((retries+1))
      
        if [ $retries -gt $max_retries ]; then
          echo "Timeout waiting for infrastructure pipeline"
          exit 1
        fi
      
        status=$(curl --silent --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          "https://gitlab.com/api/v4/projects/$INFRA_PROJECT_ID/pipelines/$INFRA_PIPELINE_ID" | jq -r '.status')
        echo "Infrastructure pipeline status: $status (retry $retries/$max_retries)"
      done
      
      if [ "$status" != "success" ]; then
        echo "Infrastructure pipeline did not complete successfully"
        exit 1
      fi
      
      echo "Infrastructure pipeline completed successfully. Staging environment is ready for testing."
      # Give extra time for services to start
      sleep 30

# Run integration tests against staging
integration-test-staging:
  stage: integration-test
  needs:
    - wait-for-infra-staging
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
  script:
    - echo "Running integration tests against staging environment..."
    - cd integration-tests
    - npm install
    # Pass the staging URLs as environment variables
    - API_BASE_URL="https://api.staging.epitechproject.fr" AUTH_BASE_URL="https://auth.staging.epitechproject.fr" npm test
  artifacts:
    paths:
      - integration-tests/test-results/
    reports:
      junit: integration-tests/test-results/junit.xml
    when: always

# Promote images to production (only if staging tests pass)
promote-to-production:
  stage: promote
  needs:
    - integration-test-staging
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      when: always
  <<: *ecr_login
  script:
    - echo "Promoting images from staging to production..."
    - docker pull $ECR_REPO/staging/frontend:$CI_COMMIT_SHA
    - docker pull $ECR_REPO/staging/api:$CI_COMMIT_SHA
    - docker pull $ECR_REPO/staging/auth:$CI_COMMIT_SHA
    
    - docker tag $ECR_REPO/staging/frontend:$CI_COMMIT_SHA $ECR_REPO/production/frontend:$CI_COMMIT_SHA
    - docker tag $ECR_REPO/staging/api:$CI_COMMIT_SHA $ECR_REPO/production/api:$CI_COMMIT_SHA
    - docker tag $ECR_REPO/staging/auth:$CI_COMMIT_SHA $ECR_REPO/production/auth:$CI_COMMIT_SHA
    - docker push $ECR_REPO/production/frontend:$CI_COMMIT_SHA
    - docker push $ECR_REPO/production/api:$CI_COMMIT_SHA
    - docker push $ECR_REPO/production/auth:$CI_COMMIT_SHA
    
    - docker tag $ECR_REPO/staging/frontend:$CI_COMMIT_SHA $ECR_REPO/production/frontend:latest
    - docker tag $ECR_REPO/staging/api:$CI_COMMIT_SHA $ECR_REPO/production/api:latest
    - docker tag $ECR_REPO/staging/auth:$CI_COMMIT_SHA $ECR_REPO/production/auth:latest
    - docker push $ECR_REPO/production/frontend:latest
    - docker push $ECR_REPO/production/api:latest
    - docker push $ECR_REPO/production/auth:latest
    
  environment:
    name: production